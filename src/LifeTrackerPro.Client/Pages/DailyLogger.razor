@page "/daily-log"
@inject DailyLogService LogSvc
@inject CategoryService CatSvc

<PageTitle>Daily Logger — LifeTracker Pro</PageTitle>

<div class="page-enter">
    <!-- Heading -->
    <h1 class="lt-page-heading">Daily <span class="accent">Logger</span></h1>
    <p class="lt-page-subtitle">Map every hour — your time, your story</p>

    <!-- Day Selector -->
    <div class="lt-day-selector">
        @foreach (var day in _days)
        {
            <div class="lt-day-pill @(day.Date == _selectedDate ? "active" : "")"
                 @onclick="() => SelectDay(day.Date)">
                <div class="day-name">@day.Date.ToString("ddd").ToUpper()</div>
                <div class="day-num">@day.Date.Day</div>
            </div>
        }
    </div>

    <!-- Auto-Fill & Date -->
    <div class="lt-card" style="margin-bottom:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:22px; font-weight:700; color:var(--ink); font-family:var(--font-serif);">
                    @_selectedDate.ToString("dddd, MMMM d")
                </div>
                <div style="font-size:11px; color:var(--ink-muted); font-family:var(--font-mono); margin-top:4px;">
                    @(_filledCount) / 24 hours mapped
                </div>
            </div>
            <button class="lt-autofill-btn" @onclick="AutoFill">
                ✦ Auto-Fill
            </button>
        </div>
    </div>

    <!-- 24-Hour Grid (2 rows × 12) -->
    <div class="lt-card" style="margin-bottom:20px;">
        <div class="lt-section-label"><span>AM — 00:00 to 11:00</span></div>
        <div class="lt-hour-grid" style="margin-bottom:16px;">
            @for (int h = 0; h < 12; h++)
            {
                var hour = h;
                var cat = _hourData[hour];
                <div class="lt-hour-cell @(cat == null ? "empty" : "")"
                     style="@GetCellStyle(cat)"
                     @onclick="() => OpenCategoryPicker(hour)">
                    <span class="hour-label">@hour.ToString("00")</span>
                    @if (cat != null)
                    {
                        <span class="cat-letter">@cat.Letter</span>
                    }
                </div>
            }
        </div>

        <div class="lt-section-label"><span>PM — 12:00 to 23:00</span></div>
        <div class="lt-hour-grid">
            @for (int h = 12; h < 24; h++)
            {
                var hour = h;
                var cat = _hourData[hour];
                <div class="lt-hour-cell @(cat == null ? "empty" : "")"
                     style="@GetCellStyle(cat)"
                     @onclick="() => OpenCategoryPicker(hour)">
                    <span class="hour-label">@hour.ToString("00")</span>
                    @if (cat != null)
                    {
                        <span class="cat-letter">@cat.Letter</span>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Category Picker (shown when editing) -->
    @if (_editingHour != null)
    {
        <div class="lt-card accent" style="margin-bottom:20px;">
            <div style="font-size:10px; color:var(--crail); font-family:var(--font-mono); font-weight:700; text-transform:uppercase; letter-spacing:0.15em; margin-bottom:12px;">
                Select category for @_editingHour.Value.ToString("00"):00
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                @foreach (var cat in _categories)
                {
                    <button class="lt-cat-button"
                            style="background:@(cat.Color)12; border-color:@(cat.Color)28; color:@cat.Color;"
                            @onclick="() => AssignCategory(_editingHour.Value, cat)">
                        <span style="margin-right:5px; font-weight:800;">@cat.Letter</span>@cat.Name
                    </button>
                }
            </div>
        </div>
    }

    <!-- Stats Row -->
    <div class="lt-grid-3">
        <div class="lt-card">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <div class="lt-stat-label">Weight</div>
                    <div class="lt-stat-value">@_weight<span class="unit">kg</span></div>
                </div>
                <span style="font-size:24px; opacity:0.15;">⚖</span>
            </div>
        </div>
        <div class="lt-card">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <div class="lt-stat-label">Spent</div>
                    <div class="lt-stat-value">$@_spent</div>
                </div>
                <span style="font-size:24px; opacity:0.15;">◎</span>
            </div>
        </div>
        <div class="lt-card">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <div class="lt-stat-label">Hours</div>
                    <div class="lt-stat-value">@_filledCount/24</div>
                </div>
                <span style="font-size:24px; opacity:0.15;">●</span>
            </div>
        </div>
    </div>

    <!-- Highlight -->
    <div class="lt-card accent">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <div style="width:3px; height:20px; border-radius:2px; background:var(--crail);"></div>
            <span style="font-size:10px; color:var(--crail); font-family:var(--font-mono); font-weight:700; text-transform:uppercase; letter-spacing:0.15em;">Highlight</span>
        </div>
        <MudTextField @bind-Value="_highlight" Variant="Variant.Text" Placeholder="What was the highlight of your day?"
                      Style="font-size:19px; color:var(--ink); font-family:var(--font-serif); font-style:italic;" />
    </div>
</div>

@code {
    private DateTime _selectedDate = DateTime.Today;
    private int? _editingHour;
    private string _highlight = "";
    private decimal _weight = 76.2m;
    private decimal _spent = 12m;

    private readonly CategoryInfo?[] _hourData = new CategoryInfo?[24];

    private int _filledCount => _hourData.Count(h => h != null);

    private record DayInfo(DateTime Date);
    private record CategoryInfo(string Name, string Letter, string Color);

    private readonly List<DayInfo> _days = Enumerable.Range(-3, 7)
        .Select(i => new DayInfo(DateTime.Today.AddDays(i)))
        .ToList();

    private readonly List<CategoryInfo> _categories = new()
    {
        new("Sleep", "S", "#6B8EC7"),
        new("Work", "W", "#C15F3C"),
        new("Hobbies", "H", "#C49A2D"),
        new("Social", "O", "#B1ADA1"),
        new("Exercise", "E", "#5B8C51"),
        new("Friends", "F", "#5CAFC7"),
        new("Book", "B", "#4A7EC7"),
        new("Partner", "P", "#C76B8E"),
        new("Family", "A", "#8E6BC7"),
        new("Productive", "D", "#7BA84A"),
        new("Travel", "T", "#4AC7A5"),
        new("Misc", "M", "#D4795A")
    };

    protected override void OnInitialized()
    {
        // Seed sample data
        for (int h = 0; h < 8; h++) _hourData[h] = _categories[0]; // Sleep
        for (int h = 9; h < 17; h++) _hourData[h] = _categories[1]; // Work
        _hourData[17] = _categories[4]; // Exercise
        _hourData[18] = _categories[4]; // Exercise
        _hourData[8] = _categories[2]; // Hobbies
        _hourData[19] = _categories[3]; // Social
        _hourData[20] = _categories[6]; // Book
    }

    private void SelectDay(DateTime date) => _selectedDate = date;

    private void OpenCategoryPicker(int hour) => _editingHour = _editingHour == hour ? null : hour;

    private void AssignCategory(int hour, CategoryInfo cat)
    {
        _hourData[hour] = cat;
        _editingHour = null;
    }

    private void AutoFill()
    {
        var rand = new Random();
        for (int h = 0; h < 24; h++)
        {
            if (_hourData[h] == null)
                _hourData[h] = _categories[rand.Next(_categories.Count)];
        }
    }

    private string GetCellStyle(CategoryInfo? cat)
    {
        if (cat == null) return "";
        return $"background:{cat.Color}20; border:1px solid {cat.Color}40; color:{cat.Color};";
    }
}
