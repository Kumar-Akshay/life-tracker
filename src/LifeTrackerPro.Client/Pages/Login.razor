@page "/login"
@inject AuthService Auth
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<PageTitle>Login — LifeTracker Pro</PageTitle>

<div class="login-bg">
    <!-- Floating Orbs -->
    <div class="login-orb" style="width:380px; height:380px; background:radial-gradient(circle, rgba(99,102,241,0.08) 0%, transparent 70%); top:10%; left:70%;"></div>
    <div class="login-orb" style="width:460px; height:460px; background:radial-gradient(circle, rgba(219,39,119,0.06) 0%, transparent 70%); top:60%; left:10%;"></div>
    <div class="login-orb" style="width:350px; height:350px; background:radial-gradient(circle, rgba(6,182,212,0.07) 0%, transparent 70%); top:30%; left:50%;"></div>
    <div class="login-orb" style="width:420px; height:420px; background:radial-gradient(circle, rgba(22,163,74,0.05) 0%, transparent 70%); top:70%; left:80%;"></div>

    <div style="width:100%; max-width:420px; position:relative; z-index:1;">
        <!-- Brand Header -->
        <div style="text-align:center; margin-bottom:36px;">
            <div style="display:inline-flex; align-items:center; gap:10px; margin-bottom:8px;">
                <div style="width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg,#6366f1,#8b5cf6); display:flex; align-items:center; justify-content:center;">
                    <span style="color:#fff; font-size:22px; font-weight:800;">L</span>
                </div>
                <span style="font-family:'Playfair Display',Georgia,serif; font-size:28px; font-weight:700; color:#f8fafc; letter-spacing:-0.02em;">LifeTracker</span>
                <span style="font-family:'Space Mono',monospace; font-size:11px; color:#818cf8; background:rgba(99,102,241,0.15); padding:2px 8px; border-radius:6px; font-weight:600;">PRO</span>
            </div>
            <p style="color:#64748b; font-size:14px; font-family:'DM Sans',sans-serif; margin-top:4px;">Track every hour. Master your life.</p>
        </div>

        <!-- Login Card -->
        <div class="glass-card-login">
            <h2 style="text-align:center; color:#f1f5f9; font-size:20px; font-weight:700; font-family:'DM Sans',sans-serif; margin:0 0 4px;">
                @(_isRegisterMode ? "Create Account" : "Welcome back")
            </h2>
            <p style="text-align:center; color:#64748b; font-size:13px; font-family:'DM Sans',sans-serif; margin:0 0 28px;">
                @(_isRegisterMode ? "Start tracking your life today" : "Sign in to continue your journey")
            </p>

            @if (_isRegisterMode)
            {
                <div style="margin-bottom:16px;">
                    <label style="display:block; color:#94a3b8; font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif; margin-bottom:6px;">Full Name</label>
                    <input @bind="_fullName" type="text" placeholder="Your full name"
                           style="width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(148,163,184,0.15); background:rgba(15,23,42,0.5); color:#e2e8f0; font-size:14px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color 0.2s;"
                           onfocus="this.style.borderColor='rgba(99,102,241,0.5)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)'" />
                </div>
            }

            <div style="margin-bottom:16px;">
                <label style="display:block; color:#94a3b8; font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif; margin-bottom:6px;">Email</label>
                <input @bind="_email" type="email" placeholder="you@example.com"
                       style="width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(148,163,184,0.15); background:rgba(15,23,42,0.5); color:#e2e8f0; font-size:14px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color 0.2s;"
                       onfocus="this.style.borderColor='rgba(99,102,241,0.5)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)'" />
            </div>

            <div style="margin-bottom:@(_isRegisterMode ? "16px" : "24px");">
                <label style="display:block; color:#94a3b8; font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif; margin-bottom:6px;">Password</label>
                <input @bind="_password" type="password" placeholder="••••••••"
                       style="width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(148,163,184,0.15); background:rgba(15,23,42,0.5); color:#e2e8f0; font-size:14px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color 0.2s;"
                       onfocus="this.style.borderColor='rgba(99,102,241,0.5)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)'" />
            </div>

            @if (_isRegisterMode)
            {
                <div style="margin-bottom:24px;">
                    <label style="display:block; color:#94a3b8; font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif; margin-bottom:6px;">Confirm Password</label>
                    <input @bind="_confirmPassword" type="password" placeholder="••••••••"
                           style="width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(148,163,184,0.15); background:rgba(15,23,42,0.5); color:#e2e8f0; font-size:14px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color 0.2s;"
                           onfocus="this.style.borderColor='rgba(99,102,241,0.5)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)'" />
                </div>
            }

            <button @onclick="HandleSubmit" disabled="@_loading"
                    style="width:100%; padding:14px; border-radius:12px; border:none; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; font-size:14px; font-weight:600; font-family:'DM Sans',sans-serif; cursor:pointer; transition:all 0.2s; opacity:@(_loading ? "0.7" : "1");">
                @if (_loading)
                {
                    <span class="spin" style="margin-right:8px;">⟳</span>
                }
                @(_isRegisterMode ? "Create Account" : "Sign In")
            </button>

            <!-- Divider -->
            <div style="display:flex; align-items:center; gap:12px; margin:24px 0;">
                <div style="flex:1; height:1px; background:rgba(148,163,184,0.1);"></div>
                <span style="color:#475569; font-size:12px; font-family:'DM Sans',sans-serif;">or</span>
                <div style="flex:1; height:1px; background:rgba(148,163,184,0.1);"></div>
            </div>

            <!-- Toggle Mode -->
            <p style="text-align:center; color:#64748b; font-size:13px; font-family:'DM Sans',sans-serif;">
                @(_isRegisterMode ? "Already have an account?" : "Don't have an account?")
                <a @onclick="ToggleMode" @onclick:preventDefault href="#"
                   style="color:#818cf8; cursor:pointer; text-decoration:none; font-weight:600; margin-left:4px;">
                    @(_isRegisterMode ? "Sign in" : "Create one")
                </a>
            </p>
        </div>

        <!-- Footer -->
        <p style="text-align:center; color:#334155; font-size:11px; font-family:'DM Sans',sans-serif; margin-top:24px;">
            Crafted for intentional living · v2.0
        </p>
    </div>
</div>

@code {
    private string _email = string.Empty;
    private string _password = string.Empty;
    private string _fullName = string.Empty;
    private string _confirmPassword = string.Empty;
    private bool _loading;
    private bool _isRegisterMode;

    private void ToggleMode()
    {
        _isRegisterMode = !_isRegisterMode;
    }

    private async Task HandleSubmit()
    {
        if (_isRegisterMode)
            await HandleRegister();
        else
            await HandleLogin();
    }

    private async Task HandleLogin()
    {
        _loading = true;
        try
        {
            var result = await Auth.LoginAsync(new LoginRequestDto
            {
                Email = _email,
                Password = _password
            });

            if (result?.Success == true)
            {
                Nav.NavigateTo("/daily-log");
            }
            else
            {
                Snackbar.Add(result?.Errors.FirstOrDefault() ?? "Login failed.", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally { _loading = false; }
    }

    private async Task HandleRegister()
    {
        if (_password != _confirmPassword)
        {
            Snackbar.Add("Passwords do not match.", Severity.Warning);
            return;
        }

        _loading = true;
        try
        {
            var result = await Auth.RegisterAsync(new RegisterRequestDto
            {
                Email = _email,
                Password = _password,
                FullName = _fullName
            });

            if (result?.Success == true)
            {
                Snackbar.Add("Account created! Welcome to LifeTracker Pro.", Severity.Success);
                Nav.NavigateTo("/daily-log");
            }
            else
            {
                foreach (var err in result?.Errors ?? new())
                    Snackbar.Add(err, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally { _loading = false; }
    }
}
